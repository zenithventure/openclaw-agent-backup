# OpenClaw Backup Service — Build, Test & Deploy
# ================================================
# SAM-based Lambda service deployed to SchedulSign accounts.
#
# Promotion flow:
#   Push to main           -> Build + Test + Deploy to Dev (automatic)
#   Tag v1.2.3-qa          -> Deploy to QA
#   Tag v1.2.3 (no suffix) -> Deploy to Prod (requires approval)
#   Manual dispatch         -> Deploy to selected environment

name: Build and Deploy

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options: [dev, qa, prod]

permissions:
  id-token: write
  contents: read

env:
  # SchedulSign accounts
  DEV_ACCOUNT_ID: "252967153935"
  QA_ACCOUNT_ID: "873595708276"
  PROD_ACCOUNT_ID: "923935061349"
  AWS_REGION: "us-east-1"
  STACK_NAME: "openclaw-backup-service"
  # Bucket name must contain "serverless" to match OIDC role S3 policy
  S3_BUCKET_PREFIX: "openclaw-serverless-artifacts"

jobs:
  # ==========================================================================
  # Build & Test — Runs on every push
  # ==========================================================================
  build-and-test:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: service/go.sum

      - name: Run tests
        working-directory: service
        run: go test -v ./...

  # ==========================================================================
  # Deploy to Dev — Automatic on push to main
  # ==========================================================================
  deploy-dev:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: service/go.sum

      - name: SAM build
        working-directory: service
        run: sam build

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.DEV_ACCOUNT_ID }}:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure S3 artifact bucket exists
        run: |
          BUCKET="${{ env.S3_BUCKET_PREFIX }}-${{ env.DEV_ACCOUNT_ID }}"
          aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null || \
            aws s3 mb "s3://$BUCKET" --region ${{ env.AWS_REGION }}

      - name: Deploy to Dev
        working-directory: service
        run: |
          PARAMS=""
          if [ -n "${{ secrets.ADMIN_API_KEY }}" ]; then
            PARAMS="--parameter-overrides AdminAPIKey=${{ secrets.ADMIN_API_KEY }}"
          fi
          sam deploy \
            --config-env ci \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --capabilities CAPABILITY_IAM \
            --s3-bucket ${{ env.S3_BUCKET_PREFIX }}-${{ env.DEV_ACCOUNT_ID }} \
            --s3-prefix ${{ env.STACK_NAME }} \
            $PARAMS

      - name: Smoke test
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)
          echo "API_URL=$API_URL"
          bash test-local.sh "$API_URL"
        env:
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}

  # ==========================================================================
  # Deploy to QA — On -qa tag or manual dispatch
  # ==========================================================================
  deploy-qa:
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'qa') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && contains(github.ref, '-qa'))
    runs-on: ubuntu-latest
    environment: qa
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: service/go.sum

      - name: Run tests
        working-directory: service
        run: go test -v ./...

      - name: SAM build
        working-directory: service
        run: sam build

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.QA_ACCOUNT_ID }}:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure S3 artifact bucket exists
        run: |
          BUCKET="${{ env.S3_BUCKET_PREFIX }}-${{ env.QA_ACCOUNT_ID }}"
          aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null || \
            aws s3 mb "s3://$BUCKET" --region ${{ env.AWS_REGION }}

      - name: Deploy to QA
        working-directory: service
        run: |
          PARAMS=""
          if [ -n "${{ secrets.ADMIN_API_KEY }}" ]; then
            PARAMS="--parameter-overrides AdminAPIKey=${{ secrets.ADMIN_API_KEY }}"
          fi
          sam deploy \
            --config-env ci \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --capabilities CAPABILITY_IAM \
            --s3-bucket ${{ env.S3_BUCKET_PREFIX }}-${{ env.QA_ACCOUNT_ID }} \
            --s3-prefix ${{ env.STACK_NAME }} \
            $PARAMS

      - name: Smoke test
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)
          echo "API_URL=$API_URL"
          bash test-local.sh "$API_URL"
        env:
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}

  # ==========================================================================
  # Deploy to Prod — On release tag or manual dispatch (requires approval)
  # ==========================================================================
  deploy-prod:
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-'))
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: service/go.sum

      - name: Run tests
        working-directory: service
        run: go test -v ./...

      - name: SAM build
        working-directory: service
        run: sam build

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.PROD_ACCOUNT_ID }}:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure S3 artifact bucket exists
        run: |
          BUCKET="${{ env.S3_BUCKET_PREFIX }}-${{ env.PROD_ACCOUNT_ID }}"
          aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null || \
            aws s3 mb "s3://$BUCKET" --region ${{ env.AWS_REGION }}

      - name: Deploy to Prod
        working-directory: service
        run: |
          PARAMS=""
          if [ -n "${{ secrets.ADMIN_API_KEY }}" ]; then
            PARAMS="--parameter-overrides AdminAPIKey=${{ secrets.ADMIN_API_KEY }}"
          fi
          sam deploy \
            --config-env ci \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --capabilities CAPABILITY_IAM \
            --s3-bucket ${{ env.S3_BUCKET_PREFIX }}-${{ env.PROD_ACCOUNT_ID }} \
            --s3-prefix ${{ env.STACK_NAME }} \
            $PARAMS

      - name: Smoke test
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)
          echo "API_URL=$API_URL"
          bash test-local.sh "$API_URL"
        env:
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
